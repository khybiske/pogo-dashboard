<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MachoMankey's PoGo Dashboard</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  background-attachment: fixed;
  padding: 10px;
  min-height: 100vh;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding-bottom: 40px;
}

/* Header */
.header {
  background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 50%, #4ECDC4 100%);
  border-radius: 20px;
  padding: 30px 20px;
  text-align: center;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  margin-bottom: 20px;
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '‚ö°';
  position: absolute;
  font-size: 120px;
  opacity: 0.1;
  top: -20px;
  right: 20px;
}

.header h1 {
  color: white;
  font-size: 32px;
  margin-bottom: 8px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  font-weight: 800;
}

.trainer-name {
  color: white;
  font-size: 20px;
  font-weight: bold;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
  letter-spacing: 1px;
}

.status-badge {
  display: inline-block;
  padding: 8px 20px;
  border-radius: 25px;
  font-size: 13px;
  font-weight: bold;
  margin-top: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.status-connected { background: #28a745; color: white; }
.status-disconnected { background: #dc3545; color: white; }
.status-loading { background: #ffc107; color: #333; }

/* Sections */
.section {
  background: white;
  border-radius: 16px;
  padding: 0;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  overflow: hidden;
  transition: transform 0.2s;
}

.section:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  cursor: pointer;
  user-select: none;
}

.section-header h2 {
  color: white;
  font-size: 22px;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

.collapse-icon {
  color: white;
  font-size: 24px;
  transition: transform 0.3s;
}

.section-header.collapsed .collapse-icon {
  transform: rotate(-90deg);
}

.section-content {
  padding: 25px;
  display: block;
}

.section-content.collapsed {
  display: none;
}

/* Pokemon Cards */
.pokemon-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  border-left: 5px solid #667eea;
  display: flex;
  gap: 15px;
  align-items: center;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  cursor: move;
}

.pokemon-card:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.pokemon-card.dragging {
  opacity: 0.5;
}

.pokemon-sprite-large {
  width: 80px;
  height: 80px;
  background: white;
  border-radius: 50%;
  padding: 5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.pokemon-info {
  flex: 1;
}

.pokemon-name {
  font-size: 20px;
  font-weight: bold;
  color: #333;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.pokemon-details {
  font-size: 13px;
  color: #666;
  line-height: 1.6;
}

/* Type Icons */
.type-icon {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: inline-block;
  margin: 2px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Special Badges */
.level-50-badge {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: #333;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Status Icons */
.status-icon {
  font-size: 20px;
  margin: 0 3px;
}

.priority-badge {
  background: linear-gradient(135deg, #FF6B6B, #FFE66D);
  color: #333;
  padding: 5px 12px;
  border-radius: 15px;
  font-weight: bold;
  font-size: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* Progress bars */
.progress-bar {
  background: #e9ecef;
  border-radius: 12px;
  height: 24px;
  overflow: hidden;
  margin-top: 8px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-fill {
  background: linear-gradient(90deg, #667eea, #764ba2);
  height: 100%;
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

/* Buttons */
.btn {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  font-weight: 600;
  margin: 5px;
  box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
  transition: all 0.3s;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(102, 126, 234, 0.6);
}

.btn:active {
  transform: translateY(0);
}

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545, #c82333);
  box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
}

.btn-success {
  background: linear-gradient(135deg, #28a745, #218838);
  box-shadow: 0 4px 10px rgba(40, 167, 69, 0.4);
}

/* Events Widget */
.event-upload {
  margin: 15px 0;
  padding: 20px;
  border: 2px dashed #667eea;
  border-radius: 12px;
  text-align: center;
  background: #f8f9fa;
}

.event-image {
  max-width: 100%;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  margin: 15px 0;
}

.event-links {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 15px;
}

.event-link {
  padding: 10px 20px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  text-decoration: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
  transition: all 0.3s;
}

.event-link:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(102, 126, 234, 0.6);
}

/* Shiny Grid */
.shiny-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.shiny-card {
  text-align: center;
  padding: 15px 10px;
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s;
  border: 2px solid transparent;
}

.shiny-card:hover {
  transform: scale(1.05);
  border-color: #FFD700;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
}

.shiny-sprite {
  width: 70px;
  height: 70px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.shiny-name {
  margin-top: 8px;
  font-size: 13px;
  font-weight: 600;
  color: #333;
}

.shiny-label {
  font-size: 10px;
  color: #FFD700;
  font-weight: bold;
  margin-top: 4px;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  overflow-y: auto;
  backdrop-filter: blur(5px);
}

.modal-content {
  background: white;
  margin: 30px auto;
  padding: 30px;
  border-radius: 16px;
  max-width: 550px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
  animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
  from {
    transform: translateY(-50px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e9ecef;
}

.modal-header h2 {
  color: #667eea;
  font-size: 24px;
}

.modal-close {
  font-size: 32px;
  cursor: pointer;
  color: #999;
  transition: color 0.3s;
}

.modal-close:hover {
  color: #dc3545;
}

/* Forms */
.form-group {
  margin-bottom: 18px;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #495057;
  font-size: 14px;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  margin: 10px 0;
  cursor: pointer;
}

input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

input[type="file"] {
  padding: 10px;
  border: 2px solid #dee2e6;
  border-radius: 8px;
  width: 100%;
}

/* Empty states */
.empty-state {
  text-align: center;
  padding: 50px 20px;
  color: #6c757d;
  font-size: 16px;
}

.loading {
  text-align: center;
  padding: 30px 20px;
  color: #6c757d;
}

/* Candy Counter */
.candy-counter {
  display: flex;
  align-items: center;
  gap: 10px;
  background: white;
  padding: 8px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.candy-count {
  min-width: 50px;
  text-align: center;
  font-weight: bold;
  font-size: 16px;
  color: #667eea;
}

/* Responsive */
@media (max-width: 600px) {
  .header h1 { font-size: 26px; }
  .trainer-name { font-size: 18px; }
  .section-header h2 { font-size: 18px; }
  .pokemon-card { flex-direction: column; text-align: center; }
  .pokemon-sprite-large { width: 60px; height: 60px; }
  .shiny-grid { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
}
</style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>‚ö° Pokemon Go Dashboard</h1>
    <div class="trainer-name">üéÆ MachoMankey</div>
    <div class="status-badge status-loading" id="syncStatus">üîÑ Syncing...</div>
  </div>

  <!-- Current Events Section -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>üìÖ Current Events</h2>
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="section-content">
      <div class="event-upload">
        <p style="margin-bottom:10px; font-weight:600;">Upload Weekly Event Graphic</p>
        <input type="file" id="eventImageUpload" accept="image/*" onchange="uploadEventImage(event)">
      </div>
      <div style="text-align: center;">
        <img id="eventImage" class="event-image" src="" alt="" style="display:none;">
        <div id="eventImageStatus" style="padding: 20px; color: #6c757d;">Upload an event graphic or check the links below</div>
        <div class="event-links">
          <a href="https://leekduck.com/events/" target="_blank" class="event-link">ü¶Ü LeekDuck Events</a>
          <a href="https://pokemongohub.net/" target="_blank" class="event-link">üì∞ PoGo Hub</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Power-Up Priority -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>‚ö° Power-Up Priority</h2>
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="section-content">
      <button class="btn" onclick="showAddPowerUpModal()">‚ûï Add Pokemon</button>
      <div id="powerUpContent">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Rare Candy Priority -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>üç¨ Rare Candy Priority</h2>
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="section-content">
      <button class="btn" onclick="showAddCandyModal()">‚ûï Add Pokemon</button>
      <div id="rareCandyContent">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Lucky Trade Management -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>ü§ù Lucky Trade Management</h2>
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="section-content">
      <h3 style="margin-bottom:15px; color: #667eea; font-size: 18px;">‚ú® Auto-Generated Wants</h3>
      <div id="autoLuckyWants">
        <div class="loading">Loading...</div>
      </div>
      
      <h3 style="margin:30px 0 15px; color: #667eea; font-size: 18px;">üìã Manual Trade Plans</h3>
      <button class="btn" onclick="showAddTradeModal()">‚ûï Add Trade Plan</button>
      <div id="tradePlansContent">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <!-- Shiny Dex Gaps -->
  <div class="section">
    <div class="section-header" onclick="toggleSection(this)">
      <h2>‚ú® Community Day Shiny Gaps</h2>
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="section-content">
      <div style="margin-bottom: 20px;">
        <button class="btn btn-small" onclick="window.open(SHEET_URL, '_blank')">üìä Open Google Sheet</button>
        <button class="btn btn-small" onclick="loadAllData()">üîÑ Refresh Data</button>
      </div>
      <div id="shinyGapsContent">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="addPowerUpModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add Power-Up Priority</h2>
      <span class="modal-close" onclick="closeModal('addPowerUpModal')">&times;</span>
    </div>
    <form id="powerUpForm" onsubmit="savePowerUp(event)">
      <div class="form-group">
        <label>Pokemon Name *</label>
        <input type="text" class="form-control" id="puPokemon" required placeholder="e.g., Rayquaza">
      </div>
      <div class="form-group">
        <label>Type(s) (comma separated)</label>
        <input type="text" class="form-control" id="puTypes" placeholder="e.g., Dragon, Flying">
      </div>
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="puLucky"> ‚≠ê Is Lucky
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="puHasElite"> ‚úÖ Has Elite/Legacy Move
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="puNeedsElite"> ‚ùó Needs Elite/Legacy Move
        </label>
      </div>
      <div class="form-group">
        <label>Current Level *</label>
        <input type="number" class="form-control" id="puCurrentLevel" step="0.5" min="1" max="55" required>
      </div>
      <div class="form-group">
        <label>Target Level *</label>
        <input type="number" class="form-control" id="puTargetLevel" step="0.5" min="1" max="55" required>
      </div>
      <div class="form-group">
        <label>Role</label>
        <select class="form-control" id="puRole">
          <option>Raid</option>
          <option>GMAX</option>
          <option>Buddy</option>
          <option>Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="puNeedLucky"> ü§ù Need Lucky Trade
        </label>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <input type="text" class="form-control" id="puNotes" placeholder="Any additional info...">
      </div>
      <div class="form-group">
        <label>Priority (1-10)</label>
        <input type="number" class="form-control" id="puPriority" min="1" max="10" value="5">
      </div>
      <div class="form-group">
        <label>Status</label>
        <select class="form-control" id="puStatus">
          <option>To Do</option>
          <option>In Progress</option>
          <option>Done</option>
        </select>
      </div>
      <button type="submit" class="btn">üíæ Save</button>
    </form>
  </div>
</div>

<div id="addCandyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add Rare Candy Priority</h2>
      <span class="modal-close" onclick="closeModal('addCandyModal')">&times;</span>
    </div>
    <form id="candyForm" onsubmit="saveCandy(event)">
      <div class="form-group">
        <label>Pokemon Name *</label>
        <input type="text" class="form-control" id="candyPokemon" required placeholder="e.g., Dialga">
      </div>
      <div class="form-group">
        <label>Current Candy *</label>
        <input type="number" class="form-control" id="candyCurrent" min="0" required>
      </div>
      <div class="form-group">
        <label>Target Candy *</label>
        <input type="number" class="form-control" id="candyTarget" min="0" required>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <input type="text" class="form-control" id="candyNotes" placeholder="e.g., Adventure Effect, Legendary">
      </div>
      <button type="submit" class="btn">üíæ Save</button>
    </form>
  </div>
</div>

<div id="addTradeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Add Trade Plan</h2>
      <span class="modal-close" onclick="closeModal('addTradeModal')">&times;</span>
    </div>
    <form id="tradeForm" onsubmit="saveTrade(event)">
      <div class="form-group">
        <label>Friend Name *</label>
        <input type="text" class="form-control" id="tradeFriend" required>
      </div>
      <div class="form-group">
        <label>What They Want</label>
        <input type="text" class="form-control" id="tradeTheyWant">
      </div>
      <div class="form-group">
        <label>What You Want</label>
        <input type="text" class="form-control" id="tradeYouWant">
      </div>
      <div class="form-group">
        <label>Notes</label>
        <input type="text" class="form-control" id="tradeNotes">
      </div>
      <div class="form-group">
        <label>Status</label>
        <select class="form-control" id="tradeStatus">
          <option>Planned</option>
          <option>Waiting</option>
          <option>Complete</option>
        </select>
      </div>
      <button type="submit" class="btn">üíæ Save</button>
    </form>
  </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxeEnHA5MtsH2yIzsKOMB4Irz9R1Wqsj6SrcsZjjSEcF2McHJYQxpUhMbcFtXGf80ybIw/exec';
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1E9tGFWTFWHNkN6OheYwQCCuXDdz3oWAmbWTStoufz_w/edit';

let powerUpData = [];
let candyData = [];
let tradePlansData = [];
let shinyGapsData = [];
let eventsData = [];

// Complete Pokemon ID mapping
const POKEMON_IDS = {
  'bulbasaur': 1, 'ivysaur': 2, 'venusaur': 3,
  'charmander': 4, 'charmeleon': 5, 'charizard': 6,
  'squirtle': 7, 'wartortle': 8, 'blastoise': 9,
  'weedle': 13, 'kakuna': 14, 'beedrill': 15,
  'pikachu': 25, 'raichu': 26,
  'sandshrew': 27, 'sandslash': 28,
  'clefairy': 35, 'clefable': 36,
  'abra': 63, 'kadabra': 64, 'alakazam': 65,
  'machop': 66, 'machoke': 67, 'machamp': 68,
  'geodude': 74, 'graveler': 75, 'golem': 76,
  'slowpoke': 79, 'slowbro': 80,
  'gastly': 92, 'haunter': 93, 'gengar': 94,
  'onix': 95,
  'rhyhorn': 111, 'rhydon': 112,
  'electabuzz': 125,
  'magmar': 126,
  'magikarp': 129, 'gyarados': 130,
  'eevee': 133,
  'porygon': 137,
  'dratini': 147, 'dragonair': 148, 'dragonite': 149,
  'mewtwo': 150, 'mew': 151,
  'chikorita': 152, 'bayleef': 153, 'meganium': 154,
  'cyndaquil': 155, 'quilava': 156, 'typhlosion': 157,
  'totodile': 158, 'croconaw': 159, 'feraligatr': 160,
  'mareep': 179, 'flaaffy': 180, 'ampharos': 181,
  'hoppip': 187, 'skiploom': 188, 'jumpluff': 189,
  'swinub': 220, 'piloswine': 221,
  'teddiursa': 216, 'ursaring': 217,
  'larvitar': 246, 'pupitar': 247, 'tyranitar': 248,
  'lugia': 249, 'ho-oh': 250,
  'treecko': 252, 'grovyle': 253, 'sceptile': 254,
  'torchic': 255, 'combusken': 256, 'blaziken': 257,
  'mudkip': 258, 'marshtomp': 259, 'swampert': 260,
  'seedot': 273, 'nuzleaf': 274, 'shiftry': 275,
  'ralts': 280, 'kirlia': 281, 'gardevoir': 282,
  'slakoth': 287, 'vigoroth': 288, 'slaking': 289,
  'roselia': 315, 'roserade': 407,
  'trapinch': 328, 'vibrava': 329, 'flygon': 330,
  'swablu': 333, 'altaria': 334,
  'duskull': 355, 'dusclops': 356,
  'bagon': 371, 'shelgon': 372, 'salamence': 373,
  'beldum': 374, 'metang': 375, 'metagross': 376,
  'regirock': 377, 'regice': 378, 'registeel': 379,
  'latias': 380, 'latios': 381,
  'kyogre': 382, 'groudon': 383, 'rayquaza': 384,
  'turtwig': 387, 'grotle': 388, 'torterra': 389,
  'chimchar': 390, 'monferno': 391, 'infernape': 392,
  'piplup': 393, 'prinplup': 394, 'empoleon': 395,
  'starly': 396, 'staravia': 397, 'staraptor': 398,
  'shinx': 403, 'luxio': 404, 'luxray': 405,
  'bronzor': 436, 'bronzong': 437,
  'gible': 443, 'gabite': 444, 'garchomp': 445,
  'uxie': 480, 'mesprit': 481, 'azelf': 482,
  'dialga': 483, 'palkia': 484,
  'heatran': 485,
  'giratina': 487,
  'cresselia': 488,
  'darkrai': 491,
  'shaymin': 492,
  'arceus': 493,
  'victini': 494,
  'snivy': 495, 'servine': 496, 'serperior': 497,
  'tepig': 498, 'pignite': 499, 'emboar': 500,
  'oshawott': 501, 'dewott': 502, 'samurott': 503,
  'roggenrola': 524, 'boldore': 525, 'gigalith': 526,
  'litwick': 607, 'lampent': 608, 'chandelure': 609,
  'deino': 633, 'zweilous': 634, 'hydreigon': 635,
  'cobalion': 638, 'terrakion': 639, 'virizion': 640,
  'tornadus': 641, 'thundurus': 642,
  'reshiram': 643, 'zekrom': 644,
  'landorus': 645,
  'kyurem': 646,
  'genesect': 649,
  'chespin': 650, 'quilladin': 651, 'chesnaught': 652,
  'fennekin': 653, 'braixen': 654, 'delphox': 655,
  'froakie': 656, 'frogadier': 657, 'greninja': 658,
  'fletchling': 661, 'fletchinder': 662, 'talonflame': 663,
  'xerneas': 716, 'yveltal': 717,
  'stufful': 759, 'bewear': 760
};

function getPokemonId(name) {
  const cleanName = name.toLowerCase().trim()
    .replace('alolan ', '')
    .replace('galarian ', '')
    .replace('hisuian ', '')
    .replace('shadow ', '')
    .replace('mega ', '');
  
  return POKEMON_IDS[cleanName] || 25;
}

function getPokemonSprite(name) {
  const id = getPokemonId(name);
  return `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
}

function getTypeIconUrl(type) {
  const typeName = type.toLowerCase().trim();
  return `https://raw.githubusercontent.com/msikma/pokesprite/master/icons/types/generation-ix/brilliant-diamond-and-shining-pearl/${typeName}.png`;
}

// Event image upload
function uploadEventImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const dataUrl = e.target.result;
    localStorage.setItem('eventImageData', dataUrl);
    displayEventImage(dataUrl);
  };
  reader.readAsDataURL(file);
}

function displayEventImage(dataUrl) {
  const img = document.getElementById('eventImage');
  const status = document.getElementById('eventImageStatus');
  
  if (dataUrl) {
    img.src = dataUrl;
    img.style.display = 'block';
    status.style.display = 'none';
  } else {
    img.style.display = 'none';
    status.style.display = 'block';
  }
}

// Toggle section
function toggleSection(header) {
  header.classList.toggle('collapsed');
  const content = header.nextElementSibling;
  content.classList.toggle('collapsed');
}

// Modal functions
function showAddPowerUpModal() {
  document.getElementById('addPowerUpModal').style.display = 'block';
  document.getElementById('powerUpForm').reset();
}

function showAddCandyModal() {
  document.getElementById('addCandyModal').style.display = 'block';
  document.getElementById('candyForm').reset();
}

function showAddTradeModal() {
  document.getElementById('addTradeModal').style.display = 'block';
  document.getElementById('tradeForm').reset();
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
}

// Load/Save functions
async function loadSheetData(sheetName) {
  try {
    const response = await fetch(`${SCRIPT_URL}?sheet=${sheetName}`);
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    return result.data || [];
  } catch (error) {
    console.error(`Error loading ${sheetName}:`, error);
    return [];
  }
}

async function saveSheetData(sheetName, data) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: JSON.stringify({ sheet: sheetName, values: data })
    });
    const result = await response.json();
    if (result.error) throw new Error(result.error);
    return true;
  } catch (error) {
    console.error(`Error saving ${sheetName}:`, error);
    alert('Save failed: ' + error.message);
    return false;
  }
}

async function loadAllData() {
  document.getElementById('syncStatus').textContent = 'üîÑ Syncing...';
  document.getElementById('syncStatus').className = 'status-badge status-loading';
  
  try {
    const [powerUp, candy, trades, shinyGaps, events] = await Promise.all([
      loadSheetData('PowerUpPriority'),
      loadSheetData('RareCandyPriority'),
      loadSheetData('LuckyTradePlans'),
      loadSheetData('CommunityDayShinies'),
      loadSheetData('EventsWidget')
    ]);
    
    powerUpData = powerUp.length > 1 ? powerUp.slice(1) : [];
    candyData = candy.length > 1 ? candy.slice(1) : [];
    tradePlansData = trades.length > 1 ? trades.slice(1) : [];
    shinyGapsData = shinyGaps.length > 1 ? shinyGaps.slice(1) : [];
    eventsData = events.length > 1 ? events.slice(1) : [];
    
    renderAll();
    
    document.getElementById('syncStatus').textContent = '‚úÖ Synced';
    document.getElementById('syncStatus').className = 'status-badge status-connected';
  } catch (error) {
    document.getElementById('syncStatus').textContent = '‚ùå Sync Error';
    document.getElementById('syncStatus').className = 'status-badge status-disconnected';
  }
}

function renderAll() {
  renderEvents();
  renderPowerUp();
  renderCandy();
  renderTrades();
  renderShinyGaps();
}

// Render Events
function renderEvents() {
  const savedImage = localStorage.getItem('eventImageData');
  displayEventImage(savedImage);
}

// Drag and Drop for Power-Up
let draggedPowerUpIndex = null;

function renderPowerUp() {
  const container = document.getElementById('powerUpContent');
  
  if (powerUpData.length === 0) {
    container.innerHTML = '<div class="empty-state">üìù No power-up priorities yet. Click "Add Pokemon" to start!</div>';
    return;
  }
  
  const sorted = [...powerUpData].sort((a, b) => parseInt(a[12]) - parseInt(b[12]));
  
  let html = '';
  sorted.forEach((row, idx) => {
    const [pokemon, types, lucky, hasElite, needsElite, currentLevel, targetLevel, role, xlCandy, dust, needLucky, notes, priority, status] = row;
    
    const typeIcons = types ? types.split(',').map(t => 
      `<img src="${getTypeIconUrl(t.trim())}" class="type-icon" alt="${t.trim()}" title="${t.trim()}" onerror="this.style.display='none'">`
    ).join('') : '';
    
    const statusIcons = [];
    if (lucky === 'TRUE') statusIcons.push('<span class="status-icon" title="Lucky">‚≠ê</span>');
    if (hasElite === 'TRUE') statusIcons.push('<span class="status-icon" title="Has Elite Move">‚úÖ</span>');
    if (needsElite === 'TRUE') statusIcons.push('<span class="status-icon" title="Needs Elite Move">‚ùó</span>');
    if (needLucky === 'TRUE') statusIcons.push('<span class="status-icon" title="Need Lucky Trade">ü§ù</span>');
    
    const level50Badge = parseFloat(targetLevel) === 50 ? '<span class="level-50-badge">LVL 50</span>' : '';
    
    html += `
      <div class="pokemon-card" draggable="true" data-index="${powerUpData.indexOf(row)}" 
           ondragstart="dragStartPowerUp(event)" ondragover="dragOverPowerUp(event)" ondrop="dropPowerUp(event)" ondragend="dragEndPowerUp(event)">
        <img class="pokemon-sprite-large" src="${getPokemonSprite(pokemon)}" onerror="this.src='https://via.placeholder.com/80'">
        <div class="pokemon-info">
          <div class="pokemon-name">
            ${pokemon} ${statusIcons.join('')} ${level50Badge}
          </div>
          <div class="pokemon-details">
            ${typeIcons}
            <br>
            <strong>Level:</strong> ${currentLevel} ‚Üí ${targetLevel} | 
            <strong>Role:</strong> ${role} | 
            <strong>Status:</strong> ${status}
            ${notes ? '<br><em>' + notes + '</em>' : ''}
          </div>
        </div>
        <div>
          <span class="priority-badge">#${priority}</span>
          <br><br>
          <button class="btn btn-small btn-danger" onclick="deletePowerUp(${powerUpData.indexOf(row)})">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function dragStartPowerUp(e) {
  draggedPowerUpIndex = parseInt(e.target.dataset.index);
  e.target.classList.add('dragging');
}

function dragOverPowerUp(e) {
  e.preventDefault();
}

function dropPowerUp(e) {
  e.preventDefault();
  const targetIndex = parseInt(e.currentTarget.dataset.index);
  
  if (draggedPowerUpIndex !== null && draggedPowerUpIndex !== targetIndex) {
    const draggedItem = powerUpData[draggedPowerUpIndex];
    powerUpData.splice(draggedPowerUpIndex, 1);
    powerUpData.splice(targetIndex, 0, draggedItem);
    
    const headers = ['Pokemon', 'Types', 'Lucky', 'Has Elite', 'Needs Elite', 'Current Level', 'Target Level', 'Role', 'XL Candy', 'Stardust', 'Need Lucky', 'Notes', 'Priority', 'Status'];
    saveSheetData('PowerUpPriority', [headers, ...powerUpData]);
    renderPowerUp();
  }
}

function dragEndPowerUp(e) {
  e.target.classList.remove('dragging');
  draggedPowerUpIndex = null;
}

// Drag and Drop for Trades
let draggedTradeIndex = null;

function renderTrades() {
  const autoContainer = document.getElementById('autoLuckyWants');
  const plansContainer = document.getElementById('tradePlansContent');
  
  const autoWants = powerUpData.filter(row => row[10] === 'TRUE');
  
  if (autoWants.length === 0) {
    autoContainer.innerHTML = '<div class="empty-state">üí° Check "Need Lucky Trade" in Power-Up Priority to auto-populate here</div>';
  } else {
    let autoHtml = '';
    autoWants.forEach(row => {
      const [pokemon, types, lucky, hasElite, needsElite, currentLevel, targetLevel, role, xlCandy, dust, needLucky, notes] = row;
      autoHtml += `
        <div class="pokemon-card" style="border-left-color: #FFD700; cursor: default;">
          <img class="pokemon-sprite-large" src="${getPokemonSprite(pokemon)}" onerror="this.src='https://via.placeholder.com/80'">
          <div class="pokemon-info">
            <div class="pokemon-name">${pokemon}</div>
            <div class="pokemon-details">
              <strong>Need for:</strong> ${role} (Level ${targetLevel})
              ${notes ? '<br><em>' + notes + '</em>' : ''}
            </div>
          </div>
        </div>
      `;
    });
    autoContainer.innerHTML = autoHtml;
  }
  
  if (tradePlansData.length === 0) {
    plansContainer.innerHTML = '<div class="empty-state">üìù No manual trade plans yet. Click "Add Trade Plan" to start!</div>';
    return;
  }
  
  let plansHtml = '';
  tradePlansData.forEach((row, idx) => {
    const [friend, theyWant, youWant, notes, status] = row;
    
    plansHtml += `
      <div class="pokemon-card" draggable="true" data-index="${idx}"
           ondragstart="dragStartTrade(event)" ondragover="dragOverTrade(event)" ondrop="dropTrade(event)" ondragend="dragEndTrade(event)">
        <div style="font-size:40px;">üë•</div>
        <div class="pokemon-info">
          <div class="pokemon-name">${friend}</div>
          <div class="pokemon-details">
            <strong>They want:</strong> ${theyWant || 'Not specified'}<br>
            <strong>You want:</strong> ${youWant || 'Not specified'}<br>
            <strong>Status:</strong> ${status}
            ${notes ? '<br><em>' + notes + '</em>' : ''}
          </div>
        </div>
        <button class="btn btn-small btn-danger" onclick="deleteTrade(${idx})">üóëÔ∏è</button>
      </div>
    `;
  });
  
  plansContainer.innerHTML = plansHtml;
}

function dragStartTrade(e) {
  draggedTradeIndex = parseInt(e.target.dataset.index);
  e.target.classList.add('dragging');
}

function dragOverTrade(e) {
  e.preventDefault();
}

function dropTrade(e) {
  e.preventDefault();
  const targetIndex = parseInt(e.currentTarget.dataset.index);
  
  if (draggedTradeIndex !== null && draggedTradeIndex !== targetIndex) {
    const draggedItem = tradePlansData[draggedTradeIndex];
    tradePlansData.splice(draggedTradeIndex, 1);
    tradePlansData.splice(targetIndex, 0, draggedItem);
    
    const headers = ['Friend', 'They Want', 'You Want', 'Notes', 'Status'];
    saveSheetData('LuckyTradePlans', [headers, ...tradePlansData]);
    renderTrades();
  }
}

function dragEndTrade(e) {
  e.target.classList.remove('dragging');
  draggedTradeIndex = null;
}

// Render Candy
function renderCandy() {
  const container = document.getElementById('rareCandyContent');
  
  if (candyData.length === 0) {
    container.innerHTML = '<div class="empty-state">üìù No rare candy priorities yet. Click "Add Pokemon" to start!</div>';
    return;
  }
  
  let html = '';
  candyData.forEach((row, idx) => {
    const [pokemon, current, target, notes] = row;
    const needed = parseInt(target) - parseInt(current);
    const progress = Math.min((parseInt(current) / parseInt(target)) * 100, 100);
    
    html += `
      <div class="pokemon-card" style="cursor: default;">
        <img class="pokemon-sprite-large" src="${getPokemonSprite(pokemon)}" onerror="this.src='https://via.placeholder.com/80'">
        <div class="pokemon-info">
          <div class="pokemon-name">${pokemon}</div>
          <div class="pokemon-details">
            <strong>Target:</strong> ${target} candies | <strong>Need:</strong> ${needed} more
            ${notes ? '<br><em>' + notes + '</em>' : ''}
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progress}%">${current} / ${target}</div>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:5px;">
          <div class="candy-counter">
            <button class="btn btn-small" onclick="updateCandy(${idx}, -10)">-10</button>
            <button class="btn btn-small" onclick="updateCandy(${idx}, -1)">-1</button>
            <span class="candy-count">${current}</span>
            <button class="btn btn-small" onclick="updateCandy(${idx}, 1)">+1</button>
            <button class="btn btn-small" onclick="updateCandy(${idx}, 10)">+10</button>
          </div>
          <button class="btn btn-small btn-danger" onclick="deleteCandy(${idx})">üóëÔ∏è Delete</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Render Shiny Gaps
function renderShinyGaps() {
  const container = document.getElementById('shinyGapsContent');
  
  if (shinyGapsData.length === 0) {
    container.innerHTML = '<div class="empty-state">üìù Update your Community Day shinies in the Google Sheet</div>';
    return;
  }
  
  const missing = shinyGapsData.filter(row => {
    const have = (row[1] || '').toString().toUpperCase();
    return have === 'N' || have === 'NO' || have === 'FALSE';
  });
  
  if (missing.length === 0) {
    container.innerHTML = '<div class="empty-state">üéâ You have all Community Day shinies!</div>';
    return;
  }
  
  let html = '<div class="shiny-grid">';
  
  missing.forEach(row => {
    const pokemon = row[0];
    html += `
      <div class="shiny-card">
        <img src="${getPokemonSprite(pokemon)}" class="shiny-sprite" onerror="this.src='https://via.placeholder.com/70'">
        <div class="shiny-name">${pokemon}</div>
        <div class="shiny-label">‚≠ê Easy Trade</div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

// Save functions
async function savePowerUp(e) {
  e.preventDefault();
  
  const newRow = [
    document.getElementById('puPokemon').value,
    document.getElementById('puTypes').value,
    document.getElementById('puLucky').checked ? 'TRUE' : 'FALSE',
    document.getElementById('puHasElite').checked ? 'TRUE' : 'FALSE',
    document.getElementById('puNeedsElite').checked ? 'TRUE' : 'FALSE',
    document.getElementById('puCurrentLevel').value,
    document.getElementById('puTargetLevel').value,
    document.getElementById('puRole').value,
    '', '',
    document.getElementById('puNeedLucky').checked ? 'TRUE' : 'FALSE',
    document.getElementById('puNotes').value,
    document.getElementById('puPriority').value,
    document.getElementById('puStatus').value
  ];
  
  const headers = ['Pokemon', 'Types', 'Lucky', 'Has Elite', 'Needs Elite', 'Current Level', 'Target Level', 'Role', 'XL Candy', 'Stardust', 'Need Lucky', 'Notes', 'Priority', 'Status'];
  powerUpData.push(newRow);
  
  const success = await saveSheetData('PowerUpPriority', [headers, ...powerUpData]);
  if (success) {
    closeModal('addPowerUpModal');
    renderPowerUp();
    renderTrades();
  }
}

async function saveCandy(e) {
  e.preventDefault();
  
  const newRow = [
    document.getElementById('candyPokemon').value,
    document.getElementById('candyCurrent').value,
    document.getElementById('candyTarget').value,
    document.getElementById('candyNotes').value
  ];
  
  const headers = ['Pokemon', 'Current', 'Target', 'Notes'];
  candyData.push(newRow);
  
  const success = await saveSheetData('RareCandyPriority', [headers, ...candyData]);
  if (success) {
    closeModal('addCandyModal');
    renderCandy();
  }
}

async function saveTrade(e) {
  e.preventDefault();
  
  const newRow = [
    document.getElementById('tradeFriend').value,
    document.getElementById('tradeTheyWant').value,
    document.getElementById('tradeYouWant').value,
    document.getElementById('tradeNotes').value,
    document.getElementById('tradeStatus').value
  ];
  
  const headers = ['Friend', 'They Want', 'You Want', 'Notes', 'Status'];
  tradePlansData.push(newRow);
  
  const success = await saveSheetData('LuckyTradePlans', [headers, ...tradePlansData]);
  if (success) {
    closeModal('addTradeModal');
    renderTrades();
  }
}

// Update/Delete functions
async function updateCandy(idx, change) {
  const current = parseInt(candyData[idx][1]);
  candyData[idx][1] = Math.max(0, current + change).toString();
  
  const headers = ['Pokemon', 'Current', 'Target', 'Notes'];
  await saveSheetData('RareCandyPriority', [headers, ...candyData]);
  renderCandy();
}

async function deletePowerUp(idx) {
  if (!confirm('Delete this entry?')) return;
  powerUpData.splice(idx, 1);
  const headers = ['Pokemon', 'Types', 'Lucky', 'Has Elite', 'Needs Elite', 'Current Level', 'Target Level', 'Role', 'XL Candy', 'Stardust', 'Need Lucky', 'Notes', 'Priority', 'Status'];
  await saveSheetData('PowerUpPriority', [headers, ...powerUpData]);
  renderPowerUp();
  renderTrades();
}

async function deleteCandy(idx) {
  if (!confirm('Delete this entry?')) return;
  candyData.splice(idx, 1);
  const headers = ['Pokemon', 'Current', 'Target', 'Notes'];
  await saveSheetData('RareCandyPriority', [headers, ...candyData]);
  renderCandy();
}

async function deleteTrade(idx) {
  if (!confirm('Delete this entry?')) return;
  tradePlansData.splice(idx, 1);
  const headers = ['Friend', 'They Want', 'You Want', 'Notes', 'Status'];
  await saveSheetData('LuckyTradePlans', [headers, ...tradePlansData]);
  renderTrades();
}

// Initialize
window.onload = loadAllData;

window.onclick = function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = 'none';
  }
};
</script>

</body>
</html>
